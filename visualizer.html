
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizzatore Audio Particellare</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0c0c0c, #1a1a2e, #16213e);
            color: white;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
        }
        
        canvas {
            display: block;
            background: radial-gradient(circle at center, rgba(15, 15, 35, 0.8), rgba(0, 0, 0, 0.9));
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        select, input[type="range"] {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        label {
            font-size: 12px;
            color: #ccc;
            min-width: 80px;
        }
        
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            color: #aaa;
        }
        
        .frequency-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 10px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="controls">
        <div class="control-group">
            <button id="startBtn">üé§ Avvia Audio</button>
            <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
        </div>
        
        <div class="control-group">
            <label>Modalit√†:</label>
            <select id="visualMode">
                <option value="particles">Particelle</option>
                <option value="numbers">Numeri</option>
                <option value="mixed">Mista</option>
                <option value="waves">Onde</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Sensibilit√†:</label>
            <input type="range" id="sensitivity" min="0.1" max="3" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label>Quantit√†:</label>
            <input type="range" id="particleCount" min="50" max="500" step="10" value="200">
        </div>
        
        <div class="control-group">
            <label>Colore:</label>
            <select id="colorMode">
                <option value="rainbow">Arcobaleno</option>
                <option value="fire">Fuoco</option>
                <option value="ocean">Oceano</option>
                <option value="matrix">Matrix</option>
                <option value="neon">Neon</option>
            </select>
        </div>
    </div>
    
    <div class="status">
        <div>Status: <span id="status">Pronto</span></div>
        <div>FPS: <span id="fps">0</span></div>
        <div>Particelle attive: <span id="activeParticles">0</span></div>
    </div>
    
    <div class="frequency-display">
        <div>Frequenze Audio:</div>
        <div id="freqData"></div>
    </div>

    <script>
        class AudioVisualizer {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.particles = [];
                this.animationId = null;
                this.isActive = false;
                
                this.settings = {
                    visualMode: 'particles',
                    sensitivity: 1,
                    particleCount: 200,
                    colorMode: 'rainbow'
                };
                
                this.fps = 0;
                this.lastTime = 0;
                this.frameCount = 0;
                
                this.setupCanvas();
                this.setupControls();
                this.initParticles();
                this.animate();
            }
            
            setupCanvas() {
                const resize = () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                };
                resize();
                window.addEventListener('resize', resize);
            }
            
            setupControls() {
                document.getElementById('startBtn').addEventListener('click', () => this.startAudio());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopAudio());
                
                document.getElementById('visualMode').addEventListener('change', (e) => {
                    this.settings.visualMode = e.target.value;
                    this.initParticles();
                });
                
                document.getElementById('sensitivity').addEventListener('input', (e) => {
                    this.settings.sensitivity = parseFloat(e.target.value);
                });
                
                document.getElementById('particleCount').addEventListener('input', (e) => {
                    this.settings.particleCount = parseInt(e.target.value);
                    this.initParticles();
                });
                
                document.getElementById('colorMode').addEventListener('change', (e) => {
                    this.settings.colorMode = e.target.value;
                });
            }
            
            async startAudio() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const source = this.audioContext.createMediaStreamSource(stream);
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    
                    source.connect(this.analyser);
                    
                    const bufferLength = this.analyser.frequencyBinCount;
                    this.dataArray = new Uint8Array(bufferLength);
                    
                    this.isActive = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('status').textContent = 'Attivo';
                    
                } catch (err) {
                    console.error('Errore accesso microfono:', err);
                    document.getElementById('status').textContent = 'Errore microfono';
                }
            }
            
            stopAudio() {
                if (this.audioContext) {
                    this.audioContext.close();
                }
                this.isActive = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('status').textContent = 'Fermato';
            }
            
            initParticles() {
                this.particles = [];
                const count = this.settings.particleCount;
                
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        size: Math.random() * 3 + 1,
                        life: 1,
                        number: Math.floor(Math.random() * 10),
                        frequency: i,
                        baseSize: Math.random() * 3 + 1,
                        angle: Math.random() * Math.PI * 2
                    });
                }
            }
            
            getColorFromMode(mode, value, index) {
                const intensity = Math.min(value / 255, 1);
                
                switch (mode) {
                    case 'rainbow':
                        const hue = (index * 10 + Date.now() * 0.1) % 360;
                        return `hsla(${hue}, 80%, ${50 + intensity * 30}%, ${intensity * 0.8})`;
                        
                    case 'fire':
                        const r = 255;
                        const g = Math.floor(intensity * 180);
                        const b = Math.floor(intensity * 50);
                        return `rgba(${r}, ${g}, ${b}, ${intensity * 0.8})`;
                        
                    case 'ocean':
                        const blue = 200 + Math.floor(intensity * 55);
                        const green = Math.floor(intensity * 150);
                        return `rgba(0, ${green}, ${blue}, ${intensity * 0.8})`;
                        
                    case 'matrix':
                        const greenVal = Math.floor(100 + intensity * 155);
                        return `rgba(0, ${greenVal}, 0, ${intensity * 0.8})`;
                        
                    case 'neon':
                        const neonHue = (index * 30) % 360;
                        return `hsla(${neonHue}, 100%, 50%, ${intensity * 0.9})`;
                        
                    default:
                        return `rgba(255, 255, 255, ${intensity * 0.8})`;
                }
            }
            
            updateParticles() {
                if (!this.isActive || !this.dataArray) return;
                
                this.analyser.getByteFrequencyData(this.dataArray);
                
                // Mostra dati frequenza
                const freqDisplay = document.getElementById('freqData');
                const sampleFreqs = [];
                for (let i = 0; i < this.dataArray.length; i += 8) {
                    sampleFreqs.push(this.dataArray[i].toString().padStart(3, '0'));
                }
                freqDisplay.textContent = sampleFreqs.slice(0, 10).join(' ');
                
                this.particles.forEach((particle, i) => {
                    const freqIndex = Math.floor((i / this.particles.length) * this.dataArray.length);
                    const audioValue = this.dataArray[freqIndex] || 0;
                    const normalizedAudio = (audioValue / 255) * this.settings.sensitivity;
                    
                    // Aggiorna movimento basato sull'audio
                    const force = normalizedAudio * 5;
                    particle.vx += (Math.random() - 0.5) * force * 0.5;
                    particle.vy += (Math.random() - 0.5) * force * 0.5;
                    
                    // Applica attrito
                    particle.vx *= 0.98;
                    particle.vy *= 0.98;
                    
                    // Movimento
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    // Rimbalzo sui bordi
                    if (particle.x < 0 || particle.x > this.canvas.width) particle.vx *= -0.8;
                    if (particle.y < 0 || particle.y > this.canvas.height) particle.vy *= -0.8;
                    
                    particle.x = Math.max(0, Math.min(this.canvas.width, particle.x));
                    particle.y = Math.max(0, Math.min(this.canvas.height, particle.y));
                    
                    // Dimensione reattiva all'audio
                    particle.size = particle.baseSize + normalizedAudio * 10;
                    particle.angle += normalizedAudio * 0.2;
                    
                    // Aggiorna vita
                    particle.life = Math.min(1, 0.3 + normalizedAudio);
                });
            }
            
            drawParticles() {
                // Sfondo con fade
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                let activeCount = 0;
                
                this.particles.forEach((particle, i) => {
                    if (particle.life < 0.1) return;
                    
                    activeCount++;
                    const audioValue = this.dataArray ? this.dataArray[Math.floor((i / this.particles.length) * this.dataArray.length)] || 0 : 0;
                    
                    this.ctx.save();
                    this.ctx.translate(particle.x, particle.y);
                    this.ctx.rotate(particle.angle);
                    
                    const color = this.getColorFromMode(this.settings.colorMode, audioValue, i);
                    this.ctx.fillStyle = color;
                    this.ctx.strokeStyle = color;
                    
                    switch (this.settings.visualMode) {
                        case 'particles':
                            this.ctx.beginPath();
                            this.ctx.arc(0, 0, particle.size, 0, Math.PI * 2);
                            this.ctx.fill();
                            
                            // Effetto glow
                            this.ctx.shadowBlur = particle.size * 2;
                            this.ctx.shadowColor = color;
                            this.ctx.fill();
                            break;
                            
                        case 'numbers':
                            this.ctx.font = `${particle.size * 4}px Courier New`;
                            this.ctx.fillText(particle.number.toString(), -particle.size, particle.size);
                            break;
                            
                        case 'mixed':
                            if (i % 2 === 0) {
                                this.ctx.beginPath();
                                this.ctx.arc(0, 0, particle.size, 0, Math.PI * 2);
                                this.ctx.fill();
                            } else {
                                this.ctx.font = `${particle.size * 3}px Courier New`;
                                this.ctx.fillText(particle.number.toString(), -particle.size, particle.size);
                            }
                            break;
                            
                        case 'waves':
                            this.ctx.beginPath();
                            this.ctx.strokeStyle = color;
                            this.ctx.lineWidth = 2;
                            const waveSize = particle.size * 3;
                            for (let j = 0; j < Math.PI * 2; j += 0.5) {
                                const x = Math.cos(j) * waveSize;
                                const y = Math.sin(j) * waveSize * Math.sin(particle.angle + j);
                                if (j === 0) this.ctx.moveTo(x, y);
                                else this.ctx.lineTo(x, y);
                            }
                            this.ctx.stroke();
                            break;
                    }
                    
                    this.ctx.restore();
                });
                
                document.getElementById('activeParticles').textContent = activeCount;
            }
            
            animate(currentTime = 0) {
                // Calcola FPS
                if (currentTime - this.lastTime >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastTime = currentTime;
                    document.getElementById('fps').textContent = this.fps;
                }
                this.frameCount++;
                
                this.updateParticles();
                this.drawParticles();
                
                this.animationId = requestAnimationFrame((time) => this.animate(time));
            }
        }
        
        // Inizializza il visualizzatore
        const visualizer = new AudioVisualizer();
        
        // Gestione errori
        window.addEventListener('error', (e) => {
            console.error('Errore:', e.error);
            document.getElementById('status').textContent = 'Errore: ' + e.message;
        });
    </script>
</body>
</html>
